import sys
from PyQt5.QtWidgets import (QApplication, QWidget, QVBoxLayout, QLabel, QLineEdit, QPushButton, QHBoxLayout, QMessageBox, QProgressBar, QFrame)
from PyQt5.QtGui import QColor, QPalette, QFont
from PyQt5.QtCore import Qt
import xml.etree.ElementTree as ET

class CommandTrainer(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle('Matrix Command Trainer - DP700')
        self.setFixedSize(750, 400)
        self.setStyleSheet('background-color: #0a0a0a;')
        self.palette = QPalette()
        self.palette.setColor(QPalette.Window, QColor('#0a0a0a'))
        self.palette.setColor(QPalette.WindowText, QColor('#00FF00'))
        self.setPalette(self.palette)
        self.font = QFont('Courier New', 8)
        self.setFont(self.font)

        import os
        self.xml_files = [f for f in os.listdir('.') if f.startswith('command_') and f.endswith('.xml')]
        self.xml_files.sort()
        self.current_file = 0
        self.errors = 0
        self.max_errors = 3
        self.parts = []
        self.descriptions = []

        self.layout = QVBoxLayout()
        self.layout.setSpacing(6)
        self.layout.setContentsMargins(10, 10, 10, 10)
        
        # ===== HEADER: Progreso Global =====
        header_frame = QFrame()
        header_frame.setStyleSheet('background: #1a1a1a; border: 1px solid #00FF00; border-radius: 3px; padding: 4px;')
        header_layout = QVBoxLayout()
        header_layout.setSpacing(2)
        
        self.progress_label = QLabel()
        self.progress_label.setStyleSheet('color: #00FF00; font-family: Courier New, monospace; font-size: 9px; font-weight: bold;')
        header_layout.addWidget(self.progress_label)
        
        self.progress_bar = QProgressBar()
        self.progress_bar.setStyleSheet('''
            QProgressBar {
                border: 1px solid #00FF00;
                background: #0a0a0a;
                height: 8px;
                text-align: center;
                font-size: 7px;
                color: #00FF00;
            }
            QProgressBar::chunk {
                background: #00FF00;
            }
        ''')
        header_layout.addWidget(self.progress_bar)
        header_frame.setLayout(header_layout)
        self.layout.addWidget(header_frame)

        # ===== TÃTULO Y DESCRIPCIÃ“N =====
        info_frame = QFrame()
        info_frame.setStyleSheet('background: #0d1b0d; border: 1px solid #00FF00; border-radius: 3px; padding: 5px;')
        info_layout = QVBoxLayout()
        info_layout.setSpacing(3)
        
        self.title_label = QLabel()
        self.title_label.setStyleSheet('color: #00FF41; font-family: Courier New, monospace; font-size: 10px; font-weight: bold;')
        self.title_label.setWordWrap(True)
        info_layout.addWidget(self.title_label)

        self.desc_label = QLabel()
        self.desc_label.setStyleSheet('color: #00DD00; font-family: Courier New, monospace; font-size: 8px;')
        self.desc_label.setWordWrap(True)
        info_layout.addWidget(self.desc_label)
        info_frame.setLayout(info_layout)
        self.layout.addWidget(info_frame)

        # ===== COMANDO VISUAL =====
        code_frame = QFrame()
        code_frame.setStyleSheet('background: #050505; border: 1px solid #00FF00; border-radius: 3px; padding: 8px;')
        code_layout = QVBoxLayout()
        code_layout.setSpacing(2)
        
        code_header = QLabel('COMANDO:')
        code_header.setStyleSheet('color: #00FF00; font-family: Courier New, monospace; font-size: 8px; font-weight: bold;')
        code_layout.addWidget(code_header)
        
        self.code_label = QLabel()
        self.code_label.setStyleSheet('background: #000; color: #00FF00; font-family: Courier New, monospace; font-size: 9px; padding: 6px; border: 1px solid #003300; border-radius: 2px;')
        self.code_label.setTextInteractionFlags(Qt.TextSelectableByMouse)
        self.code_label.setWordWrap(True)
        code_layout.addWidget(self.code_label)
        code_frame.setLayout(code_layout)
        self.layout.addWidget(code_frame)

        # ===== PISTA ACTUAL =====
        self.hint_label = QLabel()
        self.hint_label.setStyleSheet('color: #FFFF00; font-family: Courier New, monospace; font-size: 8px; background: #1a1a00; padding: 4px; border: 1px solid #FFFF00; border-radius: 2px;')
        self.hint_label.setWordWrap(True)
        self.layout.addWidget(self.hint_label)

        # ===== ENTRADA + PROGRESO DE PARTES =====
        input_frame = QFrame()
        input_frame.setStyleSheet('background: #0a0a0a; border: 1px solid #00FF00; border-radius: 3px; padding: 5px;')
        input_layout = QVBoxLayout()
        input_layout.setSpacing(3)
        
        self.part_progress_label = QLabel()
        self.part_progress_label.setStyleSheet('color: #00FF00; font-family: Courier New, monospace; font-size: 8px;')
        input_layout.addWidget(self.part_progress_label)
        
        self.input = QLineEdit()
        self.input.setStyleSheet('color: #00FF00; background: #1a1a1a; border: 2px solid #00FF00; font-family: Courier New, monospace; font-size: 10px; padding: 4px;')
        self.input.setPlaceholderText('Escribe la siguiente parte aquÃ­...')
        input_layout.addWidget(self.input)
        input_frame.setLayout(input_layout)
        self.layout.addWidget(input_frame)

        # ===== STATUS Y ERRORES =====
        status_frame = QFrame()
        status_frame.setStyleSheet('background: #0a0a0a; border: 1px solid #00FF00; border-radius: 3px; padding: 4px;')
        status_layout = QHBoxLayout()
        status_layout.setSpacing(8)
        
        self.status_label = QLabel()
        self.status_label.setStyleSheet('color: #00FF00; font-family: Courier New, monospace; font-size: 8px;')
        status_layout.addWidget(self.status_label)
        
        self.error_label = QLabel()
        self.error_label.setStyleSheet('color: #FF0000; font-family: Courier New, monospace; font-size: 8px; font-weight: bold;')
        status_layout.addWidget(self.error_label)
        
        status_layout.addStretch()
        
        self.next_btn = QPushButton('SIGUIENTE â–º')
        self.next_btn.setStyleSheet('''
            QPushButton {
                color: #00FF00; 
                background: #1a1a1a; 
                border: 1px solid #00FF00; 
                border-radius: 2px;
                padding: 4px 10px;
                font-family: Courier New, monospace;
                font-size: 8px;
                font-weight: bold;
            }
            QPushButton:hover {
                background: #00FF00;
                color: #000;
            }
        ''')
        self.next_btn.clicked.connect(self.next_command)
        self.next_btn.hide()
        status_layout.addWidget(self.next_btn)
        
        status_frame.setLayout(status_layout)
        self.layout.addWidget(status_frame)

        self.setLayout(self.layout)
        self.input.returnPressed.connect(self.check_word)
        self.load_command()

    def load_command_from_xml(self, filename):
        tree = ET.parse(filename)
        root = tree.getroot()
        title = root.find('title').text if root.find('title') is not None else ''
        description = root.find('description').text if root.find('description') is not None else ''
        parts = []
        descs = []
        for part in root.find('parts').findall('part'):
            parts.append(part.find('text').text)
            descs.append(part.find('desc').text)
        full = root.find('full').text if root.find('full') is not None else ''
        return {'title': title, 'description': description, 'parts': parts, 'descs': descs, 'full': full}

    def load_command(self):
        if self.current_file >= len(self.xml_files):
            self.progress_label.setText(f'[COMPLETADO] {len(self.xml_files)}/{len(self.xml_files)} comandos')
            self.progress_bar.setValue(100)
            self.title_label.setText('â˜… Â¡ENTRENAMIENTO COMPLETADO! â˜…')
            self.desc_label.setText('Has dominado todos los comandos del entrenamiento.')
            self.code_label.setText('Â¡Felicitaciones! EstÃ¡s listo para la certificaciÃ³n.')
            self.input.setDisabled(True)
            self.hint_label.setText('')
            self.status_label.setText('SesiÃ³n finalizada')
            self.error_label.setText('')
            self.part_progress_label.setText('')
            self.next_btn.hide()
            return
        
        self.command_data = self.load_command_from_xml(self.xml_files[self.current_file])
        self.errors = 0
        self.input.clear()
        self.parts = self.command_data['parts']
        self.descriptions = self.command_data['descs']
        self.part_index = 0
        
        # Actualizar progreso global
        progress = int((self.current_file / len(self.xml_files)) * 100)
        self.progress_label.setText(f'[PROGRESO GLOBAL] Comando {self.current_file + 1} de {len(self.xml_files)}')
        self.progress_bar.setValue(progress)
        
        self.title_label.setText(f'â–º {self.command_data["title"]}')
        self.desc_label.setText(f'Objetivo: {self.command_data["description"]}')
        self.update_code_label()
        self.update_hint_label()
        self.update_part_progress()
        self.update_error_display()
        self.input.setDisabled(False)
        self.input.setFocus()
        self.next_btn.hide()
        self.status_label.setText('Escribe la siguiente parte y presiona ENTER')
    def update_hint_label(self):
        if self.part_index < len(self.descriptions):
            self.hint_label.setText(f'ðŸ’¡ PISTA: {self.descriptions[self.part_index]}')
        else:
            self.hint_label.setText('')
    
    def update_part_progress(self):
        completed = self.part_index
        total = len(self.parts)
        percentage = int((completed / total) * 100) if total > 0 else 0
        bar = 'â–ˆ' * completed + 'â–‘' * (total - completed)
        self.part_progress_label.setText(f'Partes: [{bar}] {completed}/{total} ({percentage}%)')
    
    def update_error_display(self):
        if self.errors == 0:
            self.error_label.setText('')
        else:
            error_icons = 'âœ—' * self.errors + 'â—‹' * (self.max_errors - self.errors)
            self.error_label.setText(f'Errores: [{error_icons}] {self.errors}/{self.max_errors}')

    def expected = self.parts[self.part_index]
        
        if text == expected:
            # Â¡Correcto!
            self.part_index += 1
            self.input.clear()
            self.update_code_label()
            self.update_hint_label()
            self.update_part_progress()
            
            if self.part_index >= len(self.parts):
                # Comando completado
                self.status_label.setText('âœ“ Â¡COMANDO COMPLETADO EXITOSAMENTE!')
                self.input.setDisabled(True)
                html = f'<span style="color:#00FF00; background:#1a3a1a; font-family:Courier New,monospace; font-size:9px; font-weight:bold; padding:3px; border-radius:2px;">{self.command_data["full"]}</span>'
                self.code_label.setText(html)
                self.hint_label.setText('âœ“ Comando dominado. ContinÃºa con el siguiente.')
                self.next_btn.show()
            else:
                self.status_label.setText(f'âœ“ Correcto! ContinÃºa con la parte {self.part_index + 1}...')
                self.input.setFocus()
        else:
            # Error
            self.errors += 1
            self.update_error_display()
            self.status_label.setText(f'âœ— Incorrecto. Esperado: "{expected}"')
            self.input.clear()
            self.input.setFocus()
            
            if self.errors >= self.max_errors:
                QMessageBox.warning(
                    self, 
                    'âš  REINICIO', 
                    f'Demasiados errores ({self.max_errors}).\n\nComando reiniciado.\n\nRevisa las pistas con atenciÃ³n.'
                )
                self.load_command(x]:
            self.part_index += 1
            self.input.clear()
            self.update_code_label()
            self.update_hint_label()
            if self.part_index >= len(self.parts):
                self.status_label.setText('Â¡Comando completado!')
                self.input.setDisabled(True)
                html = f'<span style="color:#00FF00; background:#222; font-family:Consolas,monospace; font-size:20px;">{self.command_data["full"]}</span>'
                self.code_label.setText(html)
                self.next_btn.show()
        else:
            self.errors += 1
            self.status_label.setText(f'Error ({self.errors}/{self.max_errors}). Intenta de nuevo.')
            self.input.clear()
            if self.errors >= self.max_errors:
                QMessageBox.warning(self, 'Reinicio', 'Demasiados errores. Reiniciando comando.')
                self.load_command()
                self.input.setDisabled(False)

    def next_command(self):
        self.current_file += 1
        self.load_command()

    def show_description(self, idx):
        desc = self.descriptions[idx] if idx < len(self.descriptions) else 'Sin descripciÃ³n.'
        part = self.parts[idx] if idx < len(self.parts) else ''
        QMessageBox.information(self, part, desc)

if __name__ == '__main__':
    app = QApplication(sys.argv)
    window = CommandTrainer()
    window.show()
    sys.exit(app.exec_())
